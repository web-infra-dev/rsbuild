# Vite

Este capítulo apresenta como migrar um projeto Vite para o Rsbuild.

## Instalando dependências

Primeiro, você precisa substituir as dependências npm do Vite pelas dependências do Rsbuild.

import { PackageManagerTabs } from '@theme';

- Remover dependências do Vite:

<PackageManagerTabs command="remove vite" />

- Instalar dependências do Rsbuild:

<PackageManagerTabs command="add @rsbuild/core -D" />

## Atualizando scripts npm

Em seguida, você precisa atualizar os scripts npm em seu package.json para usar os comandos CLI do Rsbuild.

```json title="package.json"
{
  "scripts": {
    "dev": "vite", // [!code --]
    "build": "vite build", // [!code --]
    "preview": "vite preview", // [!code --]
    "dev": "rsbuild dev", // [!code ++]
    "build": "rsbuild build", // [!code ++]
    "preview": "rsbuild preview" // [!code ++]
  }
}
```

## Criar arquivo de configuração

Crie um arquivo de configuração do Rsbuild `rsbuild.config.ts` no mesmo diretório do package.json e adicione o seguinte conteúdo:

```ts title="rsbuild.config.ts"
import { defineConfig } from '@rsbuild/core';

export default defineConfig({
  plugins: [],
});
```

## Entrada da build

Os pontos de entrada de build padrão para Rsbuild e Vite são diferentes. O Vite usa `index.html` como entrada padrão, enquanto o Rsbuild usa `src/index.js`.

Ao migrar do Vite para o Rsbuild, você pode usar [source.entry](/config/source/entry) do Rsbuild para definir a entrada da build e [html.template](/config/html/template) para definir o template.

Usando um projeto Vite recém-criado como exemplo, primeiro exclua as tags `<script>` de `index.html`:

```html title="index.html"
<!-- [!code --] -->
<script type="module" src="/src/main.ts"></script>
```

Em seguida, adicione a seguinte configuração.

```ts title="rsbuild.config.ts"
export default {
  html: {
    template: './index.html',
  },
  source: {
    entry: {
      index: './src/main.ts',
    },
  },
};
```

O Rsbuild injetará automaticamente as tags `<script>` nos arquivos HTML gerados durante o processo de build.

## Migrando plugins

A maioria dos plugins Vite comuns podem ser facilmente migrados para plugins Rsbuild, como:

| Vite                                                                                   | Rsbuild                                                                                                             |
| :------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------ |
| [@vitejs/plugin-react](https://npmjs.com/package/@vitejs/plugin-react)                 | [@rsbuild/plugin-react](/plugins/list/plugin-react)                                                                 |
| [@vitejs/plugin-react-swc](https://npmjs.com/package/@vitejs/plugin-react-swc)         | [@rsbuild/plugin-react](/plugins/list/plugin-react)                                                                 |
| [@vitejs/plugin-vue](https://npmjs.com/package/@vitejs/plugin-vue)                     | [@rsbuild/plugin-vue](/plugins/list/plugin-vue)                                                                     |
| [@vitejs/plugin-vue2](https://npmjs.com/package/@vitejs/plugin-vue2)                   | [@rsbuild/plugin-vue2](https://github.com/rspack-contrib/rsbuild-plugin-vue2)                                       |
| [@vitejs/plugin-vue-jsx](https://npmjs.com/package/@vitejs/plugin-vue-jsx)             | [@rsbuild/plugin-vue-jsx](https://github.com/rspack-contrib/rsbuild-plugin-vue-jsx)                                 |
| [@vitejs/plugin-vue2-jsx](https://npmjs.com/package/@vitejs/plugin-vue2-jsx)           | [@rsbuild/plugin-vue2-jsx](https://github.com/rspack-contrib/rsbuild-plugin-vue2-jsx)                               |
| [@vitejs/plugin-basic-ssl](https://npmjs.com/package/@vitejs/plugin-basic-ssl)         | [@rsbuild/plugin-basic-ssl](https://github.com/rspack-contrib/rsbuild-plugin-basic-ssl)                             |
| [@vitejs/plugin-legacy](https://npmjs.com/package/@vitejs/plugin-legacy)               | Não é necessário usar, consulte [Compatibilidade do Navegador](/guide/advanced/browser-compatibility) para detalhes |
| [@sveltejs/vite-plugin-svelte](https://npmjs.com/package/@sveltejs/vite-plugin-svelte) | [@rsbuild/plugin-svelte](/plugins/list/plugin-svelte)                                                               |
| [vite-plugin-svgr](https://npmjs.com/package/vite-plugin-svgr)                         | [@rsbuild/plugin-svgr](/plugins/list/plugin-svgr)                                                                   |
| [vite-plugin-checker](https://npmjs.com/package/vite-plugin-checker)                   | [@rsbuild/plugin-type-check](https://github.com/rspack-contrib/rsbuild-plugin-type-check)                           |
| [vite-plugin-eslint](https://npmjs.com/package/vite-plugin-eslint)                     | [@rsbuild/plugin-eslint](https://github.com/rspack-contrib/rsbuild-plugin-eslint)                                   |
| [vite-plugin-static-copy](https://npmjs.com/package/vite-plugin-static-copy)           | [output.copy](/config/output/copy)                                                                                  |
| [vite-plugin-node-polyfills](https://npmjs.com/package/vite-plugin-node-polyfills)     | [@rsbuild/plugin-node-polyfill](https://github.com/rspack-contrib/rsbuild-plugin-node-polyfill)                     |
| [vite-plugin-solid](https://npmjs.com/package/vite-plugin-solid)                       | [@rsbuild/plugin-solid](/plugins/list/plugin-solid)                                                                 |
| [@preact/preset-vite](https://npmjs.com/package/@preact/preset-vite)                   | [@rsbuild/plugin-preact](/plugins/list/plugin-preact)                                                               |

Você pode consultar [Lista de Plugins](/plugins/list/index) para saber mais sobre os plugins disponíveis.

## Migração de configuração

Hera is the corresponding Rsbuild configuration for Vite configuration:

| Vite                                  | Rsbuild                                                          |
| :------------------------------------ | :--------------------------------------------------------------- |
| root                                  | [root](/config/root)                                             |
| mode                                  | [mode](/config/mode)                                             |
| base                                  | [server.base](/config/server/base)                               |
| define                                | [source.define](/config/source/define)                           |
| plugins                               | [plugins](/config/plugins)                                       |
| appType                               | [server.historyApiFallback](/config/server/history-api-fallback) |
| envDir                                | [Diretório de Ambiente](/guide/advanced/env-vars#env-directory)  |
| logLevel                              | [logLevel](/config/log-level)                                    |
| cacheDir                              | [buildCache](/config/performance/build-cache)                    |
| publicDir                             | [server.publicDir](/config/server/public-dir)                    |
| assetsInclude                         | [source.assetsInclude](/config/source/assets-include)            |
| resolve.alias                         | [resolve.alias](/config/resolve/alias)                           |
| resolve.dedupe                        | [resolve.dedupe](/config/resolve/dedupe)                         |
| resolve.extensions                    | [resolve.extensions](/config/resolve/extensions)                 |
| resolve.conditions                    | [tools.rspack.resolve.conditionNames](/config/tools/rspack)      |
| resolve.mainFields                    | [tools.rspack.resolve.mainFields](/config/tools/rspack)          |
| resolve.preserveSymlinks              | [tools.rspack.resolve.symlinks](/config/tools/rspack)            |
| html.cspNonce                         | [security.nonce](/config/security/nonce)                         |
| css.modules                           | [output.cssModules](/config/output/css-modules)                  |
| css.postcss                           | [tools.postcss](/config/tools/postcss)                           |
| css.preprocessorOptions.sass          | [pluginSass](/plugins/list/plugin-sass)                          |
| css.preprocessorOptions.less          | [pluginLess](/plugins/list/plugin-less)                          |
| css.preprocessorOptions.stylus        | [pluginStylus](/plugins/list/plugin-stylus)                      |
| css.devSourcemap                      | [output.sourceMap](/config/output/source-map)                    |
| css.lightningcss                      | [tools.lightningcssLoader](/config/tools/lightningcss-loader)    |
| server.host, preview.host             | [server.host](/config/server/host)                               |
| server.port, preview.port             | [server.port](/config/server/port)                               |
| server.cors, preview.cors             | [server.cors](/config/server/cors)                               |
| server.strictPort, preview.strictPort | [server.strictPort](/config/server/strict-port)                  |
| server.https, preview.https           | [server.https](/config/server/https)                             |
| server.open, preview.open             | [server.open](/config/server/open)                               |
| server.proxy, preview.proxy           | [server.proxy](/config/server/proxy)                             |
| server.headers, preview.headers       | [server.headers](/config/server/headers)                         |
| server.hmr                            | [dev.hmr](/config/dev/hmr), [dev.client](/config/dev/client)     |
| server.middlewareMode                 | [server.middlewareMode](/config/server/middleware-mode)          |
| build.target, build.cssTarget         | [Browserslist](/guide/advanced/browserslist)                     |
| build.outDir, build.assetsDir         | [output.distPath](/config/output/dist-path)                      |
| build.assetsInlineLimit               | [output.dataUriLimit](/config/output/data-uri-limit)             |
| build.cssMinify                       | [output.minify](/config/output/minify)                           |
| build.sourcemap                       | [output.sourceMap](/config/output/source-map)                    |
| build.lib                             | Use [Rslib](https://github.com/web-infra-dev/rslib)              |
| build.manifest                        | [output.manifest](/config/output/manifest)                       |
| build.ssrEmitAssets                   | [output.emitAssets](/config/output/emit-assets)                  |
| build.minify, build.terserOptions     | [output.minify](/config/output/minify)                           |
| build.emptyOutDir                     | [output.cleanDistPath](/config/output/clean-dist-path)           |
| build.copyPublicDir                   | [server.publicDir](/config/server/public-dir)                    |
| build.reportCompressedSize            | [performance.printFileSize](/config/performance/print-file-size) |
| ssr, worker                           | [environments](/config/environments)                             |

Notas:

- A tabela acima não cobre todas as configurações do Vite, sinta-se à vontade para adicionar mais.

## Variáveis de ambiente

O Vite injeta variáveis de ambiente que começam com `VITE_` no código do cliente por padrão, enquanto o Rsbuild injeta variáveis de ambiente que começam com `PUBLIC_` por padrão (consulte [variáveis públicas](/guide/advanced/env-vars#public-variables)).

Para ser compatível com o comportamento do Vite, você pode chamar manualmente o método [loadEnv](/api/javascript-api/core#loadenv) do Rsbuild para ler variáveis de ambiente que começam com `VITE_` e injetá-las no código do cliente através da configuração [source.define](/config/source/define).

```ts title="rsbuild.config.ts"
import { defineConfig, loadEnv } from '@rsbuild/core';

const { publicVars } = loadEnv({ prefixes: ['VITE_'] });

export default defineConfig({
  source: {
    define: publicVars,
  },
});
```

O Rsbuild injeta as seguintes [variáveis de ambiente](/guide/advanced/env-vars) por padrão:

- `import.meta.env.MODE`
- `import.meta.env.BASE_URL`
- `import.meta.env.PROD`
- `import.meta.env.DEV`

Para `import.meta.env.SSR`, você pode defini-lo através das opções de configuração [environments](/config/environments) e [source.define](/config/source/define):

```ts title="rsbuild.config.ts"
export default defineConfig({
  environments: {
    web: {
      source: {
        define: {
          'import.meta.env.SSR': JSON.stringify(false),
        },
      },
    },
    node: {
      source: {
        define: {
          'import.meta.env.SSR': JSON.stringify(true),
        },
      },
      output: {
        target: 'node',
      },
    },
  },
});
```

## Tipos predefinidos

O Vite fornece algumas definições de tipo predefinidas através do arquivo `vite-env.d.ts`. Ao migrar para o Rsbuild, você pode usar os [tipos predefinidos](/guide/basic/typescript#preset-types) fornecidos por `@rsbuild/core`:

```ts title="src/env.d.ts"
// [!code --]
/// <reference types="vite/client" />
// [!code ++]
/// <reference types="@rsbuild/core/types" />
```

## Importação global

O Vite fornece `import.meta.glob()` para importar múltiplos módulos.

Ao migrar para o Rsbuild, você pode usar a função [import.meta.webpackContext()](https://rspack.rs/api/runtime-api/module-variables#importmetawebpackcontext) do Rspack em vez disso:

- Vite:

```js
const modules = import.meta.glob('./dir/*.js');

for (const path in modules) {
  modules[path]().then((mod) => {
    console.log(path, mod);
  });
}
```

- Rsbuild:

```js
const context = import.meta.webpackContext('./dir', {
  // Se deve pesquisar subdiretórios
  recursive: false,
  regExp: /\.js$/,
});

for (const path of context.keys()) {
  const mod = context(path);
  console.log(path, mod);
}
```

## Migrando plugins Vite

A API de plugins do Rsbuild cobre a maioria dos hooks de plugins do Vite e Rollup, por exemplo:

| Hooks de plugins Vite | API de plugins Rsbuild                                                                                                 |
| :-------------------- | :--------------------------------------------------------------------------------------------------------------------- |
| `resolveId`           | [resolve](/plugins/dev/core#apiresolve)                                                                                |
| `transform`           | [transform](/plugins/dev/core#apitransform)                                                                            |
| `config`              | [modifyRsbuildConfig](/plugins/dev/hooks#modifyrsbuildconfig)                                                          |
| `configResolved`      | [getNormalizedConfig](/plugins/dev/core#apigetnormalizedconfig)                                                        |
| `configEnvironment`   | [modifyEnvironmentConfig](/plugins/dev/hooks#modifyenvironmentconfig)                                                  |
| `configureServer`     | [onBeforeStartDevServer](/plugins/dev/hooks#onbeforestartdevserver)                                                    |
| `buildStart`          | [onBeforeBuild](/plugins/dev/hooks#onbeforebuild), [onBeforeStartDevServer](/plugins/dev/hooks#onbeforestartdevserver) |
| `buildEnd`            | [onAfterBuild](/plugins/dev/hooks#onafterbuild), [onCloseDevServer](/plugins/dev/hooks#onclosedevserver)               |
| `closeBundle`         | [onCloseBuild](/plugins/dev/hooks#onclosebuild), [onCloseDevServer](/plugins/dev/hooks#onclosedevserver)               |
| `transformIndexHtml`  | [modifyHTML](/plugins/dev/hooks#modifyhtml), [modifyHTMLTags](/plugins/dev/hooks#modifyhtmltags)                       |

Consulte [Sistema de plugins](/plugins/dev/index) para mais detalhes.

## Validando resultados

Após concluir as etapas acima, você concluiu a migração básica do Vite para o Rsbuild. Agora você pode executar o comando `npm run dev` para tentar iniciar o servidor de desenvolvimento.

Se você encontrar algum problema durante o processo de build, depure de acordo com o log de erro ou verifique a configuração do Vite para ver se há alguma configuração necessária que não foi migrada para o Rsbuild.

## Suplemento de conteúdo

O documento atual cobre apenas parte do processo de migração. Se você encontrar conteúdo adequado para adicionar, sinta-se à vontade para contribuir com a documentação via pull request 🤝.

> A documentação para rsbuild can be found in the [rsbuild/website](https://github.com/web-infra-dev/rsbuild/tree/main/website) directory.
