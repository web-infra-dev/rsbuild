# Web Workers

Este capítulo apresenta como configurar e usar [Web Workers](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers) em projetos Rsbuild.

:::tip O que são Web Workers
Web Workers são um tipo de programa JavaScript que é executado em segundo plano, independentemente de outros scripts, sem afetar o desempenho da página. Isso torna possível executar scripts de longa duração, como aqueles que lidam com cálculos complexos ou acessam recursos remotos, sem bloquear a interface do usuário ou outros scripts. Web workers fornecem uma maneira fácil de executar tarefas em segundo plano e melhorar o desempenho geral de aplicações web.
:::

## Usar Web Workers

### Importar com construtores

Web Workers são cidadãos de primeira classe do Rspack, o que significa que você não precisa de nenhum loader para usar web workers diretamente em projetos Rspack ou Rsbuild.

Por exemplo, crie um arquivo chamado `worker.js`:

```js title=worker.js
self.onmessage = (event) => {
  const result = event.data * 2;
  self.postMessage(result);
};
```

Em seguida, use este worker no thread principal:

```js title=index.js
const worker = new Worker(new URL('./worker.js', import.meta.url));

worker.onmessage = (event) => {
  console.log('Os resultados dos Workers:', event.data);
};

worker.postMessage(10);
```

Para mais detalhes, consulte [Rspack - Web Workers](https://rspack.rs/guide/features/web-workers).

### Usando worker-loader

Se o seu projeto já usa `worker-loader`, ou você quer usar os recursos `inline` e outros fornecidos por `worker-loader`, você pode usar [worker-rspack-loader](https://github.com/rspack-contrib/worker-rspack-loader) como uma alternativa ao `worker-loader` em projetos Rsbuild.

```ts title="rsbuild.config.ts"
export default {
  tools: {
    rspack: {
      resolveLoader: {
        alias: {
          // Modifica a resolução de worker-loader no loader inline
          // como `worker-loader!pdfjs-dist/es5/build/pdf.worker.js`
          'worker-loader': require.resolve('worker-rspack-loader'),
        },
      },
      module: {
        rules: [
          {
            test: /\.worker\.js$/,
            loader: 'worker-rspack-loader',
          },
        ],
      },
    },
  },
};
```

Ao usar `worker-rspack-loader`, você precisa usar o `import` para importar o arquivo Web Worker, em vez de `new Worker('/path/to/worker.js')`.

```js
import Worker from './file.worker.js';

const worker = new Worker();

worker.postMessage({ a: 1 });
```

> `worker-loader` não é mais mantido, se você não precisa incorporar Web Workers, é recomendado usar a sintaxe `new Worker()`.

### Carregando scripts de URLs remotas (cross-origin)

Por padrão, o script do worker será emitido como um chunk separado. Este script suporta upload para CDN, mas deve obedecer à [política de mesma origem](https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy).

Se você quiser que seus scripts de worker sejam acessíveis entre domínios, uma solução comum é carregar via [importScripts](https://developer.mozilla.org/en-US/docs/Web/API/WorkerGlobalScope/importScripts) (não sujeito a CORS), você pode consultar o seguinte código:

```js title=index.js {2}
// https://github.com/jantimon/remote-web-worker
import 'remote-web-worker';

const worker = new Worker(new URL('./worker.js', import.meta.url), {
  type: 'classic',
});

worker.onmessage = (event) => {
  console.log('Os resultados dos Workers:', event.data);
};

worker.postMessage(10);
```

Para discussões detalhadas sobre problemas de cross-domain, consulte [Discussões - suporte a web worker do webpack 5 para CORS?](https://github.com/webpack/webpack/discussions/14648)

## Construir saídas de Web Workers

O Rsbuild suporta a construção de saídas de Web Workers independentemente, o que é útil quando você precisa fornecer saídas de Web Workers para uso por outras aplicações.

You can set Rsbuild's [output.target](/config/output/target) configuration to `'web-worker'`, and Rsbuild will generate build outputs suitable for the Web Workers environment.

```ts
export default {
  output: {
    target: 'web-worker',
  },
};
```
