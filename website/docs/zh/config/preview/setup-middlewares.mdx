# preview.setupMiddlewares

- **类型：**

```ts
type PreviewSetupMiddlewaresFn = (middlewares: {
  unshift: (...handlers: RequestHandler[]) => void;
  push: (...handlers: RequestHandler[]) => void;
}) => void;

type SetupMiddlewares = PreviewSetupMiddlewaresFn | PreviewSetupMiddlewaresFn[];
```

- **默认值：** `undefined`
- **版本：** `>= 2.0.0`

用于给 preview 服务器添加自定义中间件。

与 [dev.setupMiddlewares](/zh/config/dev/setup-middlewares) 不同，此配置不会接收 server context，因为 preview 模式没有 HMR 或 environment API。

## 基本用法

`setupMiddlewares` 函数接收一个 `middlewares` 对象，你可以使用 `unshift` 和 `push` 方法添加自定义中间件：

- 使用 `unshift` 在数组前面添加中间件，将在内置中间件之前执行。
- 使用 `push` 在数组后面添加中间件，将在内置中间件之后执行。

```ts title="rsbuild.config.ts"
export default {
  preview: {
    setupMiddlewares: (middlewares) => {
      middlewares.unshift((req, res, next) => {
        console.log('first');
        next();
      });

      middlewares.push((req, res, next) => {
        console.log('last');
        next();
      });
    },
  },
};
```

## 认证示例

一个常见的使用场景是为 preview 服务器添加认证中间件：

```ts title="rsbuild.config.ts"
export default {
  preview: {
    setupMiddlewares: (middlewares) => {
      middlewares.unshift((req, res, next) => {
        const token = req.headers['authorization'];

        if (!isValidToken(token)) {
          res.writeHead(401, { 'Content-Type': 'text/plain' });
          res.end('Unauthorized');
          return;
        }

        next();
      });
    },
  },
};
```

## 多个函数

`setupMiddlewares` 也支持传入数组，数组中的每一项都是一个设置中间件的函数：

```ts title="rsbuild.config.ts"
export default {
  preview: {
    setupMiddlewares: [
      (middlewares) => {
        middlewares.unshift(authMiddleware);
      },
      (middlewares) => {
        middlewares.push(logMiddleware);
      },
    ],
  },
};
```

## 与 dev.setupMiddlewares 的区别

| 特性           | dev.setupMiddlewares | preview.setupMiddlewares |
| -------------- | -------------------- | ------------------------ |
| 模式           | 开发模式             | 预览模式                 |
| `sockWrite`    | ✅ 可用              | ❌ 不可用                |
| `environments` | ✅ 可用              | ❌ 不可用                |
| 使用场景       | HMR、SSR 等          | 认证、日志等             |
