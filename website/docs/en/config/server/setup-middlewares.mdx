# server.setupMiddlewares

- **Type:**

```ts
type ServerSetupMiddlewaresFn = (middlewares: {
  unshift: (...handlers: RequestHandler[]) => void;
  push: (...handlers: RequestHandler[]) => void;
}) => void;

type SetupMiddlewares = ServerSetupMiddlewaresFn | ServerSetupMiddlewaresFn[];
```

- **Default:** `undefined`
- **Version:** `>= 2.0.0`

Add custom middleware to both dev server and preview server.

## Basic usage

`setupMiddlewares` function receives a `middlewares` object, you can add custom middleware by `unshift` and `push` methods:

- Use `unshift` to prepend middleware to the array, executed earlier than the built-in middleware.
- Use `push` to append middleware to the array, executed later than the built-in middleware.

```ts title="rsbuild.config.ts"
export default {
  server: {
    setupMiddlewares: (middlewares) => {
      middlewares.unshift((req, res, next) => {
        console.log('first');
        next();
      });

      middlewares.push((req, res, next) => {
        console.log('last');
        next();
      });
    },
  },
};
```

## Authentication example

A common use case is adding authentication middleware to both dev and preview servers:

```ts title="rsbuild.config.ts"
export default {
  server: {
    setupMiddlewares: (middlewares) => {
      middlewares.unshift((req, res, next) => {
        const token = req.headers['authorization'];

        if (!isValidToken(token)) {
          res.writeHead(401, { 'Content-Type': 'text/plain' });
          res.end('Unauthorized');
          return;
        }

        next();
      });
    },
  },
};
```

## Multiple functions

`setupMiddlewares` also supports passing an array, each item of which is a function to set up middlewares:

```ts title="rsbuild.config.ts"
export default {
  server: {
    setupMiddlewares: [
      (middlewares) => {
        middlewares.unshift(authMiddleware);
      },
      (middlewares) => {
        middlewares.push(logMiddleware);
      },
    ],
  },
};
```

## Difference from dev.setupMiddlewares

| Feature        | server.setupMiddlewares     | dev.setupMiddlewares |
| -------------- | --------------------------- | -------------------- |
| Mode           | Development + Preview       | Development only     |
| `sockWrite`    | ❌ Not available            | ✅ Available         |
| `environments` | ❌ Not available            | ✅ Available         |
| Use case       | Shared middleware for serve | HMR, SSR, etc.       |
