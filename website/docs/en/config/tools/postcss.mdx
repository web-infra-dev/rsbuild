# tools.postcss

- **Type:** `Object | Function`
- **Default:**

```js
const defaultOptions = {
  postcssOptions: {
    config: false,
    sourceMap: rsbuildConfig.output.sourceMap.css,
  },
};
```

Rsbuild integrates PostCSS by default, you can configure [postcss-loader](https://github.com/webpack-contrib/postcss-loader) through `tools.postcss`.

## Examples

### Adding PostCSS plugins (function type)

When `tools.postcss` is a function, the default options will be passed in as the first parameter. You can directly modify this object or return a new object as the final options to be used.

#### Add a single plugin

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      addPlugins(require('postcss-px-to-viewport'));
    },
  },
};
```

#### Add plugins with configuration

To pass parameters to the PostCSS plugin, call the PostCSS plugin as a function:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      const viewportPlugin = require('postcss-px-to-viewport')({
        viewportWidth: 375,
      });
      addPlugins(viewportPlugin);
    },
  },
};
```

#### Add multiple plugins

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      addPlugins([
        require('postcss-preset-env'),
        require('postcss-import'),
        require('autoprefixer'),
      ]);
    },
  },
};
```

### Modifying default options

You can also modify the default `postcss-loader` options:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts) => {
      opts.sourceMap = false;
      // Modify PostCSS options
      opts.postcssOptions.parser = 'sugarss';
    },
  },
};
```

### Complete configuration replacement

`tools.postcss` can return a config object and completely replace the default config:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: () => {
      return {
        postcssOptions: {
          plugins: [require('postcss-px-to-viewport')],
        },
      };
    },
  },
};
```

### Object type configuration

When `tools.postcss` is an object, it will be merged with the default configuration using `Object.assign`. Note that `Object.assign` is a shallow copy and will completely overwrite the built-in `presets` or `plugins` array, please use it with caution.

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: {
      // As `Object.assign` is used, the default postcssOptions will be overwritten.
      postcssOptions: {
        plugins: [require('postcss-px-to-viewport')],
      },
    },
  },
};
```

## Advanced examples

### Mobile-first responsive design

Configure PostCSS for mobile development with viewport units:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      addPlugins([
        require('postcss-px-to-viewport')({
          viewportWidth: 375,
          viewportHeight: 667,
          unitPrecision: 3,
          viewportUnit: 'vw',
          selectorBlackList: ['.ignore', '.hairlines'],
          minPixelValue: 1,
          mediaQuery: false,
        }),
        require('postcss-viewport-height-correction'),
      ]);
    },
  },
};
```

### Advanced CSS preprocessing

Set up PostCSS with advanced preprocessing capabilities:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      addPlugins([
        require('postcss-import'), // Must be first
        require('postcss-nested'),
        require('postcss-custom-properties'),
        require('postcss-custom-media'),
        require('postcss-calc'),
        require('autoprefixer'),
      ]);
    },
  },
};
```

### CSS-in-JS optimization

Configure PostCSS for CSS-in-JS libraries:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      addPlugins([
        require('postcss-styled-syntax'),
        require('postcss-emotion'),
        require('autoprefixer'),
        require('cssnano')({
          preset: [
            'default',
            {
              discardComments: {
                removeAll: true,
              },
            },
          ],
        }),
      ]);
    },
  },
};
```

### Environment-specific configuration

Different PostCSS configurations for different environments:

```ts title="rsbuild.config.ts"
const isDev = process.env.NODE_ENV === 'development';

export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      const plugins = [
        require('postcss-import'),
        require('postcss-nested'),
        require('autoprefixer'),
      ];

      if (isDev) {
        // Development plugins
        plugins.push(require('postcss-browser-reporter'));
        plugins.push(require('postcss-reporter'));
      } else {
        // Production plugins
        plugins.push(
          require('cssnano')({
            preset: 'default',
          }),
        );
        plugins.push(require('postcss-combine-duplicated-selectors'));
      }

      addPlugins(plugins);
    },
  },
};
```

### Design system integration

Configure PostCSS for design system tokens:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      addPlugins([
        require('postcss-import'),
        require('postcss-custom-properties')({
          importFrom: './src/design-tokens.css',
          preserve: false,
        }),
        require('postcss-custom-media')({
          importFrom: './src/media-queries.css',
        }),
        require('postcss-color-function'),
        require('autoprefixer'),
      ]);
    },
  },
};
```

### Multiple PostCSS configurations

`tools.postcss.postcssOptions` can be set to a function, which receives the Rspack's `loaderContext` as a parameter. This allows you to use different PostCSS options for different file paths.

#### Path-based configuration

Use different plugins for different file paths:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: {
      postcssOptions: (loaderContext) => {
        if (/foo/.test(loaderContext.resourcePath)) {
          return {
            plugins: [require('postcss-plugin-a')],
          };
        }
        return {
          plugins: [require('postcss-plugin-b')],
        };
      },
    },
  },
};
```

#### Module-specific configuration

Different configurations for CSS modules vs regular CSS:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: {
      postcssOptions: (loaderContext) => {
        const isCSSModule = /\.module\.(css|scss|less)$/.test(
          loaderContext.resourcePath,
        );

        const basePlugins = [
          require('postcss-import'),
          require('autoprefixer'),
        ];

        if (isCSSModule) {
          // CSS Modules specific plugins
          return {
            plugins: [
              ...basePlugins,
              require('postcss-modules-values'),
              require('postcss-modules-scope'),
            ],
          };
        }

        // Regular CSS plugins
        return {
          plugins: [
            ...basePlugins,
            require('postcss-nested'),
            require('postcss-custom-properties'),
          ],
        };
      },
    },
  },
};
```

### Framework-specific configurations

#### Tailwind CSS integration

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      addPlugins([require('tailwindcss'), require('autoprefixer')]);
    },
  },
};
```

#### Bootstrap integration

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      addPlugins([
        require('postcss-import'),
        require('postcss-flexbugs-fixes'),
        require('postcss-preset-env')({
          autoprefixer: {
            flexbox: 'no-2009',
          },
          stage: 3,
        }),
      ]);
    },
  },
};
```

### Performance optimization

Configure PostCSS for optimal performance:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      // Order plugins by performance impact
      addPlugins([
        require('postcss-import'), // Must be first
        require('postcss-url'), // Handle URLs early
        require('postcss-nested'),
        require('postcss-custom-properties'),
        require('autoprefixer'),
        // Optimization plugins last
        require('postcss-merge-rules'),
        require('postcss-discard-duplicates'),
        require('cssnano')({
          preset: [
            'default',
            {
              calc: false, // Disable if using postcss-calc
              colormin: false, // Preserve color formats
            },
          ],
        }),
      ]);

      // Enable source maps only in development
      opts.sourceMap = process.env.NODE_ENV === 'development';
    },
  },
};
```

### Custom parser configuration

Use custom PostCSS parsers for different CSS syntaxes:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts) => {
      // Configure for SCSS-like syntax
      opts.postcssOptions.parser = require('postcss-scss');

      // Or for Less-like syntax
      // opts.postcssOptions.parser = require('postcss-less');

      return opts;
    },
  },
};
```

### Plugin ordering and dependencies

Handle plugin dependencies and ordering:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      // Plugins must be added in specific order
      addPlugins([
        // 1. Import plugins first
        require('postcss-import'),

        // 2. Syntax plugins
        require('postcss-nested'),
        require('postcss-custom-properties'),

        // 3. Transformation plugins
        require('postcss-calc'),
        require('postcss-color-function'),

        // 4. Vendor prefixing
        require('autoprefixer'),

        // 5. Optimization plugins last
        require('cssnano'),
      ]);
    },
  },
};
```

## Utils

### addPlugins

- **Type:** `(plugins: PostCSSPlugin | PostCSSPlugin[]) => void`

For adding additional PostCSS plugins, You can pass in a single PostCSS plugin, or an array of PostCSS plugins.

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (config, { addPlugins }) => {
      // Add a PostCSS Plugin
      addPlugins(require('postcss-preset-env'));
      // Add multiple PostCSS Plugins
      addPlugins([require('postcss-preset-env'), require('postcss-import')]);
    },
  },
};
```

## Common use cases

### Migrating from webpack

When migrating from webpack, you might have existing PostCSS configurations:

```ts title="rsbuild.config.ts"
// Equivalent to webpack postcss-loader configuration
export default {
  tools: {
    postcss: {
      postcssOptions: {
        plugins: [
          [
            'postcss-preset-env',
            {
              stage: 1,
              features: {
                'nesting-rules': true,
              },
            },
          ],
          'autoprefixer',
        ],
      },
    },
  },
};
```

### Debugging PostCSS

Enable debugging and reporting for PostCSS:

```ts title="rsbuild.config.ts"
export default {
  tools: {
    postcss: (opts, { addPlugins }) => {
      if (process.env.NODE_ENV === 'development') {
        addPlugins([
          require('postcss-reporter')({
            clearReportedMessages: true,
            throwError: false,
          }),
        ]);
      }
    },
  },
};
```

## Notes

:::tip
If the project contains a `postcss.config.*` config file, its content will be merged with `tools.postcss.postcssOptions`, and the latter's priority is higher. The `plugins` array will be merged into a single array.
:::

### PostCSS version

Rsbuild uses the PostCSS v8. When you use third-party PostCSS plugins, please pay attention to whether the PostCSS version is compatible. Some legacy plugins may not work in PostCSS v8.

### PostCSS config loading

Rsbuild uses [postcss-load-config](https://github.com/postcss/postcss-load-config) to load PostCSS config files and merge them with the default config.

Rsbuild internally sets the `postcss-loader`'s `postcssOptions.config` option to `false` to avoid loading config files repeatedly.

### Performance considerations

- Order plugins correctly (import plugins first, optimization plugins last)
- Use source maps only in development to improve production build speed
- Consider using PostCSS caching for large projects
- Some plugins like `autoprefixer` can be heavy - configure them appropriately
