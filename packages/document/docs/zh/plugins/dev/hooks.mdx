# Plugin Hooks

本章节描述了 Rsbuild 插件提供的生命周期钩子。

## 概览

**Common Hooks**

- `modifyRsbuildConfig`：修改传递给 Rsbuild 的配置项。
- `modifyRspackConfig`：修改最终的 Rspack 配置对象。
- `modifyBundlerChain`：通过 chain api 修改 Rspack / webpack 配置对象。
- `onBeforeCreateCompiler`：在创建 compiler 实例前调用。
- `onAfterCreateCompiler`：在创建 compiler 实例后、执行构建前调用。

**Build Hooks**：仅在执行 build 方法构建生产环境产物时调用。

- `onBeforeBuild`：在执行生产环境构建前调用。
- `onAfterBuild`：在执行生产环境构建后调用，可以获取到构建结果信息。

**Dev Server Hooks**：仅在执行 startDevServer 方法运行开发服务器时调用。

- `onBeforeStartDevServer`：在启动开发服务器前调用。
- `onAfterStartDevServer`：在启动开发服务器后调用。
- `onDevCompileDone`：在每次开发环境构建结束后调用。

**Prod Server Hooks**：仅在执行 preview 方法运行生产预览服务器时调用。

- `onBeforeStartProdServer`：在启动开发服务器前调用。
- `onAfterStartProdServer`：在启动开发服务器后调用。

**Other Hooks**

- `onExit`：在进程即将退出时调用。

## Common Hooks

### modifyRsbuildConfig

修改传递给 Rsbuild 的配置项，你可以直接修改传入的 config 对象，也可以返回一个新的对象来替换传入的对象。

- **类型：**

```ts
type ModifyRsbuildConfigUtils = {
  mergeRsbuildConfig: typeof mergeRsbuildConfig;
};

function ModifyRsbuildConfig(
  callback: (
    config: RsbuildConfig,
    utils: ModifyRsbuildConfigUtils,
  ) => PromiseOrNot<RsbuildConfig | void>,
): void;
```

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.modifyRsbuildConfig((config, { mergeRsbuildConfig }) => {
      config.html = config.html || {};
      config.html.title = 'Hello World!';
      return mergeRsbuildConfig(config, {
        source: { preEntry: 'foo.js' },
      });
    });
  },
});
```

### modifyRspackConfig

修改最终的 Rspack 配置对象，你可以直接修改传入的 config 对象，也可以返回一个新的对象来替换传入的对象。

- **类型：**

```ts
type ModifyRspackConfigUtils = {
  env: NodeEnv;
  isDev: boolean;
  isProd: boolean;
  target: RsbuildTarget;
  isServer: boolean;
  isWebWorker: boolean;
  rspack: typeof import('@rspack/core');
};

function ModifyRspackConfig(
  callback: (
    config: RspackConfig,
    utils: ModifyRspackConfigUtils,
  ) => Promise<RspackConfig | void> | RspackConfig | void,
): void;
```

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.modifyRspackConfig((config, utils) => {
      if (utils.env === 'development') {
        config.devtool = 'eval-cheap-source-map';
      }
    });
  },
});
```

### modifyBundlerChain

:::tip 什么是 BundlerChain

import BundlerChain from '@zh/shared/bundlerChain.md';

<BundlerChain />
:::

`modifyBundlerChain` 用于调用 bundler chain 来修改 Rspack 的配置。

- **类型：**

```ts
type ModifyBundlerChainUtils = {
  env: NodeEnv;
  isDev: boolean;
  isProd: boolean;
  target: RsbuildTarget;
  isServer: boolean;
  isWebWorker: boolean;
  CHAIN_ID: ChainIdentifier;
  HtmlPlugin: typeof import('html-webpack-plugin');
  bundler: {
    // 取决于 bundler 类型
    BannerPlugin: typeof webpack.BannerPlugin | typeof rspack.BannerPlugin;
    DefinePlugin: typeof webpack.DefinePlugin | typeof rspack.DefinePlugin;
    ProvidePlugin: typeof webpack.ProvidePlugin | typeof rspack.ProvidePlugin;
  };
};

function ModifyBundlerChain(
  callback: (
    chain: BundlerChain,
    utils: ModifyBundlerChainUtils,
  ) => Promise<void> | void,
): void;
```

- **示例：**

```ts
import { BundleAnalyzerPlugin } from 'webpack-bundle-analyzer';

export default () => ({
  setup: (api) => {
    api.modifyBundlerChain((chain, utils) => {
      if (utils.env === 'development') {
        chain.devtool('eval');
      }

      chain.plugin('bundle-analyze').use(BundleAnalyzerPlugin);
    });
  },
});
```

### onBeforeCreateCompiler

import OnBeforeCreateCompiler from '@zh/shared/onBeforeCreateCompiler.md';

<OnBeforeCreateCompiler />

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.onBeforeCreateCompiler(({ bundlerConfigs }) => {
      console.log('the bundler config is ', bundlerConfigs);
    });
  },
});
```

### onAfterCreateCompiler

import OnAfterCreateCompiler from '@zh/shared/onAfterCreateCompiler.md';

<OnAfterCreateCompiler />

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.onAfterCreateCompiler(({ compiler }) => {
      console.log('the compiler is ', compiler);
    });
  },
});
```

## Build Hooks

### onBeforeBuild

import OnBeforeBuild from '@zh/shared/onBeforeBuild.md';

<OnBeforeBuild />

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.onBeforeBuild(({ bundlerConfigs }) => {
      console.log('the bundler config is ', bundlerConfigs);
    });
  },
});
```

### onAfterBuild

import OnAfterBuild from '@zh/shared/onAfterBuild.md';

<OnAfterBuild />

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.onAfterBuild(({ stats }) => {
      console.log(stats?.toJson());
    });
  },
});
```

## Dev Server Hooks

### onBeforeStartDevServer

import OnBeforeStartDevServer from '@zh/shared/onBeforeStartDevServer.md';

<OnBeforeStartDevServer />

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.onBeforeStartDevServer(() => {
      console.log('before start!');
    });
  },
});
```

### onAfterStartDevServer

import OnAfterStartDevServer from '@zh/shared/onAfterStartDevServer.md';

<OnAfterStartDevServer />

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.onAfterStartDevServer(({ port, routes }) => {
      console.log('this port is: ', port);
      console.log('this routes is: ', routes);
    });
  },
});
```

### onDevCompileDone

import OnDevCompileDone from '@zh/shared/onDevCompileDone.md';

<OnDevCompileDone />

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.onDevCompileDone(({ isFirstCompile }) => {
      if (isFirstCompile) {
        console.log('first compile!');
      } else {
        console.log('re-compile!');
      }
    });
  },
});
```

## Prod Server Hooks

### onBeforeStartProdServer

import OnBeforeStartProdServer from '@zh/shared/onBeforeStartProdServer.md';

<OnBeforeStartProdServer />

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.onBeforeStartProdServer(() => {
      console.log('before start!');
    });
  },
});
```

### onAfterStartProdServer

import OnAfterStartProdServer from '@zh/shared/onAfterStartProdServer.md';

<OnAfterStartProdServer />

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.onAfterStartProdServer(({ port, routes }) => {
      console.log('this port is: ', port);
      console.log('this routes is: ', routes);
    });
  },
});
```

## Other Hooks

### onExit

import OnExit from '@zh/shared/onExit.md';

<OnExit />

- **示例：**

```ts
export default () => ({
  setup: (api) => {
    api.onExit(() => {
      console.log('exit!');
    });
  },
});
```
